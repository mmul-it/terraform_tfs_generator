# Subnet that will be created:
{% for subnet in azure_subnets %}
# {{ subnet.name }} {{ subnet.prefix }}
{% endfor %}

# Virtual network creation block
resource "azurerm_virtual_network" "{{ azure_vnet_name }}" {
  name                = "{{ azure_vnet_name }}"
  address_space       = ["{{ azure_vnet_addr_space }}"]
  location            = azurerm_resource_group.{{ azure_resource_group_name }}.location
  resource_group_name = azurerm_resource_group.{{ azure_resource_group_name }}.name
}

# Subnet creation block(s)
{% for subnet in azure_subnets %}
resource "azurerm_subnet" "{{ subnet.name }}" {
  name                 = "{{ subnet.name }}"
  resource_group_name  = azurerm_resource_group.{{ azure_resource_group_name }}.name
  virtual_network_name = azurerm_virtual_network.{{ azure_vnet_name }}.name
  address_prefix       = "{{ subnet.prefix }}"
}

{% endfor -%}
{% if azure_public_ips|length > 0 %}
# Public IPs creation block
{% for ipname in azure_public_ips %}
{% set allocation_method = ipname.type|default ('Static') %}
# {{ ipname.name }} Public IP
resource "azurerm_public_ip" "publicip_{{ ipname.name }}" {
  name                = "publicip_{{ ipname.name }}"
  resource_group_name = azurerm_resource_group.{{ azure_resource_group_name }}.name
  location            = azurerm_resource_group.{{ azure_resource_group_name }}.location
  allocation_method   = "{{ allocation_method }}"
}
{% if allocation_method == 'Dynamic' %}
data "azurerm_public_ip" "publicip_{{ ipname.name }}" {
  name                = azurerm_public_ip.publicip_{{ ipname.name }}.name
  resource_group_name = azurerm_resource_group.{{ azure_resource_group_name }}.name
}
output "{{ ipname.name }}_public_ip_address" {
  value = data.azurerm_public_ip.publicip_{{ ipname.name }}.ip_address
}
{% else %}
output "{{ ipname.name }}_public_ip_address" {
  value = azurerm_public_ip.publicip_{{ ipname.name }}.ip_address
}
{% endif %}

{% endfor %}
{% endif %}
